2021年度 サブゼミ 第13回 Webスクレイピング
================
Yoshinari Namba
2021/8/11

# 0. イントロダクション

今日のAgendaは以下の3つです．  
1. スクレイピングの概要  
2. Rでの実装  
3. グループワーク

自力でWebからデータを取ってこれるようになることが今日の目標です！

# 1. スクレイピングの概要

## スクレイピングとは?

スクレイピングはWeb上のデータを自動で取得する方法です．  
欲しいデータの量が少ないときはコピペ・ダウンロードすれば良いのですが，膨大なデータが必要な場合は手作業でやると大変です．そこでスクレイピングを使います．

## 必要な知識

Webからデータを取ってくるので，Webサイトを構成するコード(HTML・CSS)をある程度知っておく必要があります.  
- HTML: Webページの枠組みを作る  
- CSS: HTML作った枠組みに肉付け(文字や配色の詳細設定)を行う

今日は深入りしないでおきます．とりあえず，HTMLが「大見出し→小見出し→本文」のような階層構造を持っていることだけ頭に入れておいて下さい！

## 注意点

サーバーを攻撃していると見なされると大変なことになります。データを繰り返し取得する際には適切な時間を空けましょう

## スクレイピングの手順

スクレイピングはざっくり以下の手順で行います(小澤さんのQiita記事)．  
1. 欲しいデータが載っているサイトを探す  
2. 欲しいデータがそのサイトのどの部分に記載されているかを把握する
@ブラウザ  
3. Rでコードを書いてデータを取得する @R

以降はこの手順で実装していきます！

# 2. Rでの実装

## 2-1. 欲しいデータが載っているサイトを探す

PC周辺機器の口コミを分析するケースを考えてみます．口コミはいろんなサイトに載っていると思いますが，ここでは楽天のレビューを使うことにしましょう．

## 2-2. 欲しいデータがそのサイトのどの部分に記載されているかを把握する @ブラウザ

### HTMLコードを開く

次のリンクから楽天のレビューページを開いてください．  
- <https://review.rakuten.co.jp/search/-/100026/cu1001-d0/>

開けたら右クリックをして「検証」を選択してください
(Edgeユーザーは「開発者ツールで調査する」)．

### 欲しいデータがHTML上のどの階層に位置しているのかを確認

左上の矢印マークを押して，欲しいデータが載っている場所をクリックしてください．  
ハイライトされているコードの中に「class =
“…”」という部分が見つかると思います．  
\[おまけ\] Google Chromeの拡張機能Selector Gadgetを使う

## 2-3. Rでコードを書いてデータを取得する @R

コーディングは以下の手順で行います  
- Step1: 準備  
- Step2: 1つページからデータを取得  
- Step3: Step2を利用して2ページ目以降からデータを自動的に取得

### Step1: 準備

RStudioを開いて右上のタブの File -> New Project
から新規プロジェクトを作成しておいてください．

#### パッケージのインストール

スクレイピングには`rvest`というパッケージを使用します．  
あとで使う`tidyverse`も合わせて先に必要なパッケージを呼び出しましょう．

``` r
# パッケージのインストール
install.packages("rvest")

# パッケージの呼び出し
library(rvest)
library(tidyverse)
```

まだインストールしていない人は`install.packages("tidyverse")`から実行するようにしてください．

#### ウェブサイトを指定する

まずはサイトのurlを指定します．htmlを読み込むには`rvest::read_html()`を使います．

``` r
# 対象のサイトのURLを指定
url <- read_html("https://review.rakuten.co.jp/search/-/100026/cu1001-d0/")
```

実行してみるとエラーが出てしまいます．エンコ―ディングの問題で読み込めないみたいです．正しいエンコードを知るには`guess_encoding()`を使います
[1]．

``` r
guess_encoding("https://review.rakuten.co.jp/search/-/100026/cu1001-d0/")
```

    ## # A tibble: 5 x 2
    ##   encoding   confidence
    ##   <chr>           <dbl>
    ## 1 EUC-JP           1   
    ## 2 Big5             0.85
    ## 3 GB18030          0.79
    ## 4 EUC-KR           0.65
    ## 5 ISO-8859-1       0.26

このサイトは`EUC-JP`というエンコードが信憑性が高そうです．このエンコードで再度読み込みます．

``` r
# エンコードを指定して再度読み込み
url <- read_html("https://review.rakuten.co.jp/search/-/100026/cu1001-d0/", 
                 encoding = "EUC-JP")
```

### Step2: 1つのページからデータを取得

urlから欲しいデータを取ってくるには`html_nodes()`というコマンドを使用します．`()`内には先ほどブラウザで確認したパス(HTML上の位置)を指定します．また，取ってきたデータをテキストの形式で出力するために`html_text()`を使います．

``` r
# データの取得
reviews <- url %>% 
  html_nodes(".ratCustomAppearTarget") %>%  # 欲しい情報の位置を指定
  html_text()                               # テキスト形式で出力
```

ちゃんとデータが取れているか最初の10行を確認してみましょう．

``` r
# 確認
head(reviews, n = 10)
```

    ##  [1] "\n以前こちらのショップでデスクトップを購入し、問題無く使用できて満足しているので今回ノートが必要になった際にもこちらを選びました。\n蓋部分？（液晶の裏側）は結構使用感のあるものが届きましたが、中はキレイでした。\n使用していても全く問題ありません。\n本体の値段だけみればもう少し安いショップもありましたが、Wi-Fi対応にするにはオプションで追加しなければならないなど、必要なものを付けたらそこそこの値段になるショップばかりで、総合的にみるとここが良いかなと思います。\n"
    ##  [2] "\nゲーミングヘッドセットとしても使用しますが、塾のzoom授業でも活躍出来そうです。\n"                                                                                                                                                                                                                                                                                                                                                                                             
    ##  [3] "\nETCカードを読み込まなくなり購入。\n製品使用後、正常に動作しました。\nカー用品店にも売ってないので、助かりました。\n"                                                                                                                                                                                                                                                                                                                                                          
    ##  [4] "\n500平米程の敷地で使用するために購入しました。\n3台のセットでほぼ全域カバー出来て大変満足です。ネット閲覧や動画視聴などがメインですが、速度も快適です。\n広めの場所をカバーするなら大変おすすめ。\n"                                                                                                                                                                                                                                                                           
    ##  [5] "\n配送が早く助かりました。また商品の性能についても大方想定どおりでしたので満足しています。\nまた機会があれば利用させていただきます。ありがとうございました。\n"                                                                                                                                                                                                                                                                                                                 
    ##  [6] "\nパソコンとルーターからの距離もありLANケーブルだと配線に手間がかかるので繋がればラッキー的な気持ちで購入しました。添付されていたCDで無線LANアダブタをインストールし、ルーターのリセットボタンを押したら簡単に繋がりました。受信動作も全く問題がありません。\n値段が安かったので購入には不安がありましたが、購入して正解でした。\n良心的な価格で良い商品をありがとうございました。\n"                                                                                           
    ##  [7] "\nデザインでブルーの部分が気持ちいいです。異常なく作動できています。持ち運びが頻繁になるので今後どのようになるか？です。\n"                                                                                                                                                                                                                                                                                                                                                     
    ##  [8] "\nPS5のシステムβテストに当選したので、参加のため購入しました。取説は同梱されていませんが、商品説明に装着方法が記載されておりましたので、簡単に装着できました。冷却性能は分かりかねますが、動作に問題がないことを確認しましたので、冷却できていると思います。ヒートシンク自体初めての購入で比較ができませんが、よいお品だと思います。\n"                                                                                                                                        
    ##  [9] "\n触り心地はサラサラで多少角張ってる感じはした\n無線も有線も違和感はないのでよい商品だと思います\n"                                                                                                                                                                                                                                                                                                                                                                             
    ## [10] "\n妻の専用機として購入。綺麗なホワイトカラーで気に入った様です。スペックもワードやエクセル程度ならこれで充分です。\n"

`\n`が何度も出てきて気持ち悪いですね…
`str_replace_all()`を使って消してみましょう．
(ちなみに`\n`は改行を表しています．)

``` r
# \n を削除
reviews <- reviews %>% 
  str_replace_all(pattern = '\n', replacement = '')

# 確認
head(reviews, n = 10)
```

    ##  [1] "以前こちらのショップでデスクトップを購入し、問題無く使用できて満足しているので今回ノートが必要になった際にもこちらを選びました。蓋部分？（液晶の裏側）は結構使用感のあるものが届きましたが、中はキレイでした。使用していても全く問題ありません。本体の値段だけみればもう少し安いショップもありましたが、Wi-Fi対応にするにはオプションで追加しなければならないなど、必要なものを付けたらそこそこの値段になるショップばかりで、総合的にみるとここが良いかなと思います。"
    ##  [2] "ゲーミングヘッドセットとしても使用しますが、塾のzoom授業でも活躍出来そうです。"                                                                                                                                                                                                                                                                                                                                                                                       
    ##  [3] "ETCカードを読み込まなくなり購入。製品使用後、正常に動作しました。カー用品店にも売ってないので、助かりました。"                                                                                                                                                                                                                                                                                                                                                        
    ##  [4] "500平米程の敷地で使用するために購入しました。3台のセットでほぼ全域カバー出来て大変満足です。ネット閲覧や動画視聴などがメインですが、速度も快適です。広めの場所をカバーするなら大変おすすめ。"                                                                                                                                                                                                                                                                         
    ##  [5] "配送が早く助かりました。また商品の性能についても大方想定どおりでしたので満足しています。また機会があれば利用させていただきます。ありがとうございました。"                                                                                                                                                                                                                                                                                                             
    ##  [6] "パソコンとルーターからの距離もありLANケーブルだと配線に手間がかかるので繋がればラッキー的な気持ちで購入しました。添付されていたCDで無線LANアダブタをインストールし、ルーターのリセットボタンを押したら簡単に繋がりました。受信動作も全く問題がありません。値段が安かったので購入には不安がありましたが、購入して正解でした。良心的な価格で良い商品をありがとうございました。"                                                                                         
    ##  [7] "デザインでブルーの部分が気持ちいいです。異常なく作動できています。持ち運びが頻繁になるので今後どのようになるか？です。"                                                                                                                                                                                                                                                                                                                                               
    ##  [8] "PS5のシステムβテストに当選したので、参加のため購入しました。取説は同梱されていませんが、商品説明に装着方法が記載されておりましたので、簡単に装着できました。冷却性能は分かりかねますが、動作に問題がないことを確認しましたので、冷却できていると思います。ヒートシンク自体初めての購入で比較ができませんが、よいお品だと思います。"                                                                                                                                  
    ##  [9] "触り心地はサラサラで多少角張ってる感じはした無線も有線も違和感はないのでよい商品だと思います"                                                                                                                                                                                                                                                                                                                                                                         
    ## [10] "妻の専用機として購入。綺麗なホワイトカラーで気に入った様です。スペックもワードやエクセル程度ならこれで充分です。"

とりあえずこのページから必要なデータが取れましたね．

### Step3: 2ページ目以降からデータを自動的に取得

1ページで終わりならコピペとそれほど労力はかわらないかもしれません．でも，数十，数百ページからデータを取ろうとするとスクレイピングの方が圧倒的に早いです．  
ここからはStep2で書いたコードを使って複数ページからデータを取得するコードを書きます

#### URLの規則を把握する

ページを変えるとURLも変わるため，指定するURLを変えなければいけません．  
URLの変化の仕方が規則的ならば複数ページからデータを取る作業を自動化することができます．  
実際に2ページ目を見てみると末尾が`....-d0-p2/`，3ページ目は`...-d0-p3/`となっています．

``` r
# データを取得
for(i in 2:10){
  url_tmp <- paste0("https://review.rakuten.co.jp/search/-/100026/cu1001-d0-p", i, "/") %>% # iページ目のURLを作成
    read_html(encoding = "EUC-JP")                    # ページの読み込み
  reviews_tmp <- url_tmp %>% 
    html_nodes(".ratCustomAppearTarget") %>%          # データの位置を指定 
    html_text() %>%                                   # テキスト形式で出力
    str_replace_all(pattern = "\n", replacement = "") # 文字を整える
  reviews <- c(reviews, reviews_tmp)                  # i-1ページ目までのデータと結合
  Sys.sleep(1)                                        # 1秒時間を空ける
}

# 確認
reviews[201:210]
```

    ##  [1] "2Tからの買い替えです 問題なく動いています"                                                                                                                                                                                                                                                                        
    ##  [2] "良い商品です。設定も簡単にできました。"                                                                                                                                                                                                                                                                           
    ##  [3] "中古とは思えないきれいな状態で到着しました。電源オンでWiFiに接続するだけですぐにネットサーフィンができ満足です。やはりＳＳＤは起動が爆速で感激です！"                                                                                                                                                             
    ##  [4] "今まで使っていたルーターが古すぎてパソコンのセキュリティに警告がでるようになったのでこちらのものに買い換えました。設置場所にもよるのかもしれませんが、以前使用していたものよりWi-Fiのマークをみると若干弱いかんじもするのですが、問題なく使用できています。こういう分野に詳しくはないですが無事に接続できました。"
    ##  [5] "一体型と迷いましたが、簡単に脱着できそうだったので線有りの方にしました。抜き差しが少し硬めですが、色もMacのスペースグレイとマッチしていい感じです！"                                                                                                                                                              
    ##  [6] "迅速な配送でした。商品もすぐに使えました。"                                                                                                                                                                                                                                                                       
    ##  [7] "想像以上に小さく可愛いです。またよろしくお願いいたします。"                                                                                                                                                                                                                                                       
    ##  [8] "安すぎて不安だったのですが、問題なく使えました"                                                                                                                                                                                                                                                                   
    ##  [9] "注文してすぐに届きました。今のところ、何の問題もなく使えてます。"                                                                                                                                                                                                                                                 
    ## [10] "ダイソンと迷いましたがパナソニックを買って正解です！デザインではダイソンに負けていますが二倍の価格差を払うメリットがダイソンに感じられませんでした。風量もかなり強く、ナノイーが利いてるのかわかりませんが髪の毛がしっとりしてまとまります！"

# 3. グループワーク

今まで学んだことを実践してみましょう．
次のサイトから東京都港区のコンビニのデータを取得してみてください．  
- <https://www.homemate-research-convenience-store.com/13103/>

欲しいデータは  
- 店舗名  
- 住所

とします．時間に余裕があったら，これらを1つのデータフレームにまとめてみてください．また，
- 口コミ数

もGetしてみてください．

# \< 参考 \>

-   小澤さん「RでのWeb
    スクレイピング入門」(<https://qiita.com/Tom-tom-tom/items/998e8282d013fb218490>)  
-   村松ほか, 「スクレイピングによるデータ収集」, 技術評論社,
    『RユーザーのためのRStudio入門「実践編」』，第2章

[1] `guess_encoding`は`tidyverse`の中にある`readr`というパッケージの中にあります．
